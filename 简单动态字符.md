## 简单动态字符

### 描述
Redis没有直接使用C语言传统的字符串表示（已空字符结尾的字符数组），而是自己构建了一种名为简单动态字符串（`simple dynamic string`，`SSD`）的抽象类型，并将SDS作为Redis的默认字符串表示。
Redis中字符串所有的表示都是SDS对象，包括键值对中键的表示。

### 结构体定义
```
struct sdshdr {
    // 记录buf数组中已使用直接的数量
    // 等于SDS说保存字符串的长度，不含结尾空字符（1个字节）长度
    int len;
    // 记录buf数组中未使用字节的数量
    int free;
    // 字节数组，用于保存字符数组
    char buf[];
}
```
数据结构如下图所示：
![](/images/sds.png)

### 为何这么设计

#### 遵循空字符串结尾  
SDS遵循C字符串已空字符串结尾的惯例，保存空字符串的1字节空间（不计算在SDS的len属性中），并且会额外开辟额外的一个字节空间。遵循这个惯例的好处是，SDS可以字节重用部分C字符串函数库中的函数，比如`prinf()`等....  

#### 参数复杂度获取字符串长度  
因为C字符串并不记录自身的长度信息，所以为了获取C字符串长度，需要遍历整个字符串串，复杂度为O(N)。SDS的len属性中记录来SDS本身的长度，所以获取一个SDS的长度复杂度为O(1)。

#### 防止缓冲区溢出
除了获取字符串长度的复杂度高之外，C字符串不记录长度还有导致另外一个问题就是统一造成缓冲区溢出（`buffer overflow`）。假设程序中有两个在内存中紧紧相邻的C字符串s1和s2。其中s1保存的字符串是`"Redis"`,而s2保存的字符串是"MongoDB"。那么这个时候如果想要将s1的内容修改为"Redis Cluster"，但是忘记了在执行修改前为s1分配足够的空间，那么这个时候会导致s2的内存会被意外的修改了。  
SDS的空间分配策略完全杜绝了发生缓冲区溢出的可能性。当API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求，不满足的话，API会自动将SDS的空间扩展至所需的大小，然后执行实际的修改操作。所以不会出现前面所说的缓冲区溢出问题。

#### 减少修改字符串带来的内存重分配次数
##### 空间预分配
对于C字符串，每次进行一次增长或者缩短的话都会做一次内存的重分配。   为了避免C字符串的这种缺陷，SDS的结构设计解除了字符串长度和底层数组长度之间的关联。在SDS中，buf数组的长度不一定就是字符数量加1，数组里面可以包含未使用的字节，而这些字节的数量就是由SDS中free的属性记录的，可以避免字符串增长情况下内存再分配，因为预分配了额外的字符空间。

##### 空间预分配策略

- 如果对SDS进行修改后，SDS的长度（也就是len的属性）小于1MB，那么程序分配和len属性相同大小的未使用空间，这时SDS的len属性的值和free属性的值相同。举个栗子，如果进行修改后，SDS的len变成了13字节，那么程序会额外分配13字节的未使用空间，那么SDS的buf数组的实际长度会变成13+13+1=27字节。
- 如果对SDS进行修改后，SDS的长度大于等于1MB，那么程序会分配1MB的未使用空间。举个例子，如果进行修改后，SDS的len变成了30MB，那么程序会分配1MB的未使用空间，SDS的buf数组的实际长度为30MB+1MB+1byte

##### 惰性空间释放

惰性空间释放用于优化SDS的字符串缩短操作，当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存分配来回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录下来，并等待将来使用。通过惰性空间释放策略，SDS避免了缩短字符串时所需的内存重分配操作，并未将来可能有的增长操作提供了优化。于此同时，SDS也提供了相应的API，让为们可以在需要时，真正释放SDS的未使用空间，所以不用担心惰性空间释放策略会造成内存浪费。

#### 二进制安全

C字符串中的字符必须符合某种编码，并且除了字符串的末尾之外，字符串里面不能包含空字符，否则最先会被程序认为读入空字符将被误以为是字符串结尾，这些限制了C字符串智能保存文本数据，不能保存像图片、音频、视频等这样的二进制文件。
为了避免这样的问题，SDS有了buf和len的设计，可以做到二进制安全（binary-safe），所有的SDS API都会以处理二进制的方式来处理SDS存放在buf数组中的数据。数据在写入的时候什么样，取出来的时候就是什么样。

### API
[Redis字符串API](http://redisdoc.com/string/index.html)